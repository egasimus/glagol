#!/usr/bin/env etude
(let [port 1620

      server-http
        (new (.-Server (require :http)))
      on-http
        (fn [req res]
          (log.as :http :connection))

      server-ws
        (new (.-Server (require :ws)) { :server server-http })
      on-ws
        (fn [socket]
          (log.as :ws :connection)
            ((require :q-connection) socket ./api))]

  (log.as :hello "starting with modules:" (.join (keys ./api) " "))

  (server-http.on :request on-http)
  (server-ws.on :connection on-ws)
  (server-http.listen port)
  
  {})
