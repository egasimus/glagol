(let [addr      ./options/library-socket
      WebSocket (require :ws)
      socket    (new WebSocket ./options/library-socket)
      queue     []]

  (socket.on :open
    (fn []
      (queue.map (fn [args] (log queue) (socket.send.apply nil args)))
      (set! queue [])
      (log.as addr :opened)))

  (socket.on :message
    (fn [data flags]
      (log.as addr data)))

  { :send
      (fn [& args]
        (if (= WebSocket.OPEN socket.ready-state)
          (log :send args)
          (log :queue args))) })
