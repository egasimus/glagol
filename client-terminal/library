(let [addr      ./options/library-socket
      WebSocket (require :ws)
      socket    (new WebSocket ./options/library-socket)
      send      (fn [data] (socket.send (JSON.stringify data)))
      queue     []]

  (socket.on :open
    (fn []
      (queue.map send)
      (set! queue [])
      (log.as addr :opened)))

  (socket.on :message
    (fn [data flags]
      (log.as addr data)))

  { :send
      (fn [& args]
        (if (= WebSocket.OPEN socket.ready-state)
          (send args)
          (queue.push args))) })
