(let [Diff (require "deep-diff")]
  (fn mainloop [screen get-template get-data]
    (let [parse     (fn [] (./parse ((get-template) (get-data))))
          parsed    (parse)
          render    (fn [parsed] (./render screen parsed))
          rendered  (render parsed)
          refresh   nil]

      (set! refresh (fn refresh[]
        (let [new-parsed   (parse)
              new-rendered (render new-parsed)
              changes      (or (Diff parsed new-parsed) [])]
          (changes.map (./change/bind nil screen))
          (screen.remove rendered)
          (set! rendered new-rendered)
          (screen.append rendered)
          (screen.render)
          (set-timeout refresh ../options/refresh-rate))))

      (refresh))))

      ;(screen.render))))
