(let [screen (./template/render (./template/main {}))
      keymap ./options/keymap]

  (screen.render)

  ;; dispatch keyboard events by keymap
  (screen.on "keypress" (fn [c k]
    (.map (keys keymap) (fn [event]
      (if (> (.index-of (aget keymap event) k.full) -1)
        (./events/emit event k))))))

  ;(set! ./template [:watch (fn [] (log "UPDATE"))])

  ;; react to events
  (./events/on :exit    (fn [] (process.exit)))
  (./events/on :refresh (fn [] (screen.realloc) (screen.render)))
  (./events/on :update  (fn [] (log.as :update arguments)))

  { :undo (fn [] (screen.destroy)) })
