(fn render [widgets node]
  (let [widget (aget widgets node.widget)]
    (if (not widget)
      (throw (Error (str "unknown widget " node.widget)))
      (let [rendered (widget node.options node.content)]
        (set! node.rendered rendered)
        (if node.children (node.children.map (fn [child-node]
          (let [rendered-child-node (render widgets child-node)]
            (rendered.append rendered-child-node)
            (set! rendered-child-node.parent rendered)))))
        rendered))))
